---
sidebar_position: 41
description: >-
   Query the storage and access the historical state with gRPC requests to the node
title: State queries
---

# Storage calls and state queries

It is sometimes impossible to extract the required data with only event and call data without querying the runtime state.
The context exposes a lightweight gRPC client to the chain node accessible via `ctx._chain`. 
It exposes low-lever method for accessing the storage. However, the recommended way to query the storage is by generating type-safe access classes with [Substrate typegen](/develop-a-squid/typegen). 

To enable the gRPC client, **one must provide a `chain` data source to the processor**:

```typescript
const processor = new SubstrateBatchProcessor()
    .setDataSource({
        archive: lookupArchive("kusama", {release: "FireSquid"})
        chain: 'wss://kusama-rpc.polkadot.io'
    })
```

:::tip
We recommend using private endpoints for better performance and stability of your squids. A standard way is to use environement variables and set them via [secrets](/deploy-squid/env-variables#secrets) when deploying to Aquarium.
:::

## Type-safe storage access with typegen

The Substrate typegen generates access classes in `src/types/storage.ts` which take into account the historical runtime upgrades by exposing versioned getters (like `asVxx`). The generated access methods support single and multi key queries and allow to query storage keys and pairs. 

Note that the generated getters **always query the historical block height of the "current" block derived the context**. This is the recommended way to access the storage.

To generate the storage classes with typegen:

* Set an archive GraphQL endpoint to `specVersions`. For a list of public archives, check the [Aquarium page](https://app.subsquid.io/aquarium/archives) and pick the data source URL at the archive page.
* List the fully qualified names of the storage items to the `storage` section of the typegen config. The format is `${PalleteName}.${KeyName}`.
* Rerun the typegen with

```bash
make typegen
```

Here's an example of `typegen.json` for generating an access class for `Balances.Reserves`:

```json title=typegen.json
{
  "outDir": "src/types",
  "specVersions": "https://kusama.archive.subsquid.io/graphql", 
  "storage": [
    "Balances.Account"
  ]
}
```
To generate all the available storage calls, set `"storage": true`.


Inspect the generated storage access classes in `src/types/storage.ts`. It should look similar to this:

```typescript title=src/types/storage.ts
/**
 * This code is generated by typegen
 */
export class SystemAccountStorage extends StorageBase {
  //.. constructors

 get isVxx(): boolean {
     return this.getTypeHash() === '2208f857b7cd6fecf78ca393cf3d17ec424773727d0028f07c9f0dc608fc1b7a'
 }

 get asVxx(): SystemAccountStorageVxx {
     assert(this.isVxx)
     return this as any
 }
}

export interface SystemAccountStorageVxx {
    get(key: Uint8Array): Promise<vxx.AccountInfo>
    getAll(): Promise<vxx.AccountInfo[]>
    getMany(keys: Uint8Array[]): Promise<vxx.AccountInfo[]>
    getKeys(): Promise<Uint8Array[]>
    getKeys(key: Uint8Array): Promise<Uint8Array[]>
    getKeysPaged(pageSize: number): AsyncIterable<Uint8Array[]>
    getKeysPaged(pageSize: number, key: Uint8Array): AsyncIterable<Uint8Array[]>
    getPairs(): Promise<[k: Uint8Array, v: vxx.AccountInfo][]>
    getPairs(key: Uint8Array): Promise<[k: Uint8Array, v: vxx.AccountInfo][]>
    getPairsPaged(pageSize: number): AsyncIterable<[k: Uint8Array, v: vxx.AccountInfo][]>
    getPairsPaged(pageSize: number, key: Uint8Array): AsyncIterable<[k: Uint8Array, v: vxx.AccountInfo][]>
}

```

The generated access interface provide methods for:

- accessing a single storage item with `get(...keys)`
- accessing multiple storage items in a batch call with `getMany(keys[])`
- accessing all values at a given key prefix with `getAll()`
- accessing all storage keys with a given prefix with `getKeys(...keys)` (only if storage keys are decodable)
- paged accessing all storage keys with a given prefix with `getKeysPaged(pageSize: number, ...keys)` (only if storage keys are decodable)
- accessing all storage key-value pairs at a given key prefix with `getPairs(...keys)` (only if storage keys are decodable)
- paged accessing all storage key-value pairs at a given key prefix with `getPairsPaged(pageSize: number, ...keys)` (only if storage keys are decodable)



## Access Storage items within a handler

As previously mentioned, the storage items are always retrieved at the "current" block height of `StorageContext`. To instantiate a storage access class, pass the current block hash wrapped as `{ hash: string }` as the second constructor argument.

### Example

```typescript title=processor.ts
import {BalancesAccountStorage} from "./types/storage"

const processor = new SubstrateBatchProcessor()
    .setBatchSize(50)
    .setBlockRange({ from: 9_000_000, to: 9_100_000})
    .setDataSource({
        // Lookup archive by the network name in the Subsquid registry
        archive: lookupArchive("kusama", {release: "FireSquid"}),
        // use a private endpoint for production
        chain: 'wss://kusama-rpc.polkadot.io'
    }).includeAllBlocks({ from: 9_000_000, to: 9_100_000})


processor.run(new TypeormDatabase(), async ctx => {
    for (const block of ctx.blocks) { 
      // block.header is of type { hash: string }
      let storage = new BalancesAccountStorage(ctx, block.header)
      let aliceAddress = ss58.decode('5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY').bytes
      let aliceBalance = (await storage.asV1050.get(aliceAddress)).free
      ctx.log.info(`Alice free account balance at block ${block.header.height}: ${aliceBalance.toString()}`)
    }
})
```
